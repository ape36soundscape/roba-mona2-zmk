name: Build ZMK Firmware (Local Manifest Safe Build)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install west and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install west docopt pyyaml colorama packaging

      - name: Initialize Local ZMK workspace
        run: |
          set -euo pipefail
          echo "üß© Initializing local ZMK workspace..."
          rm -rf zmk-workspace || true
          mkdir -p zmk-workspace
          cd zmk-workspace

          # „É≠„Éº„Ç´„É´ZMK„Çí manifest ‰ª£„Çè„Çä„Å´‰ΩøÁî®
          west init -l ../zmk
          west update
          west zephyr-export

          echo "ZEPHYR_BASE=$(pwd)/zmk/zephyr" >> $GITHUB_ENV
          echo "ZMK_APP=$(pwd)/zmk/app" >> $GITHUB_ENV
          echo "ZMK_WS=$(pwd)" >> $GITHUB_ENV
          echo "‚úÖ Local ZMK manifest initialized."

      - name: Detect XIAO BLE board (auto)
        id: detect
        run: |
          echo "Detecting Seeeduino XIAO BLE board..."
          echo "BOARD_NAME=seeeduino_xiao_ble" >> $GITHUB_ENV

      - name: Build Left Firmware
        run: |
          set -e
          echo "üèóÔ∏è Building Left Firmware..."
          west build -p -b ${BOARD_NAME} -d build/left zmk/app \
            -- -DSHIELD=roba_compat_mona_left \
               -DZMK_CONFIG=${GITHUB_WORKSPACE}/config

      - name: Build Right Firmware
        run: |
          set -e
          echo "üèóÔ∏è Building Right Firmware..."
          west build -p -b ${BOARD_NAME} -d build/right zmk/app \
            -- -DSHIELD=roba_compat_mona_right \
               -DZMK_CONFIG=${GITHUB_WORKSPACE}/config

      - name: Upload UF2 Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: zmk-uf2
          path: |
            build/left/zephyr/zmk.uf2
            build/right/zephyr/zmk.uf2
