name: Build ZMK Firmware

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        board: [seeeduino_xiao_ble]
        shield: [roba_compat_mona_left, roba_compat_mona_right]

    steps:
      - name: Fetch Build Keyboards
        uses: actions/checkout@v4

      - name: Remove GitHub Auth Headers (fix 128 error)
        run: |
          echo "ðŸ§¹ Removing leftover auth headers..."
          git config --system --unset-all http.https://github.com/.extraheader || true
          git config --global --unset-all http.https://github.com/.extraheader || true
          git config --local --unset-all http.https://github.com/.extraheader || true
          echo "âœ… Auth headers removed."

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install west and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install west docopt pyyaml colorama packaging ruamel.yaml click

      - name: Initialize ZMK workspace
        run: |
          set -euo pipefail
          ZMK_WS="${RUNNER_TEMP}/zmk-ws"
          rm -rf "$ZMK_WS" || true
          mkdir -p "$ZMK_WS"
          cd "$ZMK_WS"

          echo "Initializing ZMK workspace..."
          west init -m https://github.com/zmkfirmware/zmk-config.git .
          west update
          west zephyr-export

          echo "ZEPHYR_BASE=$(pwd)/zephyr" >> $GITHUB_ENV
          echo "ZMK_APP=$(pwd)/zmk/app" >> $GITHUB_ENV
          echo "ZMK_WS=$ZMK_WS" >> $GITHUB_ENV

      - name: Build
        working-directory: ${{ env.ZMK_WS }}
        run: |
          set -euo pipefail
          west build -p always -b ${{ matrix.board }} -d build/${{ matrix.shield }} $ZMK_APP \
            -DSHIELD=${{ matrix.shield }} \
            -DZMK_CONFIG=${GITHUB_WORKSPACE}/config \
            -DUSER_SHIELD_DIR=${GITHUB_WORKSPACE}/boards/shields \
            -DZEPHYR_TOOLCHAIN_VARIANT=gnuarmemb \
            -DGNUARMEMB_TOOLCHAIN_PATH=/usr

      - name: Upload UF2 Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.shield }}
          path: |
            ${{ env.ZMK_WS }}/build/${{ matrix.shield }}/zephyr/*.uf2
